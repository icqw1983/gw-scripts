#!/bin/sh

LAN_IF=eno1
WAN_IF=enp2s0
BRIDGE_IF=br0
VPN_IF=tun+

FROM_BRIDGE="-i ${BRIDGE_IF}"
TO_BRIDGE="-o ${BRIDGE_IF}"

FROM_VPN="-i ${VPN_IF}"
TO_VPN="-o ${VPN_IF}"

FROM_LO="-i lo"
TO_LO="-o lo"

FROM_LAN="${FROM_BRIDGE} -m physdev --physdev-in ${LAN_IF}"
FROM_WAN="${FROM_BRIDGE} -m physdev --physdev-in ${WAN_IF}"

TO_LAN="${TO_BRIDGE} -m physdev --physdev-out ${LAN_IF}"
TO_WAN="${TO_BRIDGE} -m physdev --physdev-out ${WAN_IF}"

FROM_WAN_TO_LAN="${FROM_WAN} ${TO_LAN}"
FROM_LAN_TO_WAN="${FROM_LAN} ${TO_WAN}"

MARK_MASK="0xff"
FOR_BRIDGE="0x01/${MARK_MASK}"
FOR_DEFAULT="0x99/${MARK_MASK}"
FOR_ANY="0x00/${MARK_MASK}"

TO_ALL=""
ALL=""

ipt() {
    iptables $* 2>&1
    ip6tables $* 2>&1
}

ipt4() {
    iptables $* 2>&1
}

ipt6() {
    ip6tables $* 2>&1
}

flush_firewall() {
    ipt -t raw -F
    ipt -t raw -X
    ipt -t filter -F
    ipt -t filter -X
    ipt -t mangle -F
    ipt -t mangle -X
    ipt -t nat -F
    ipt -t nat -X
}

policies() {
    ipt -t filter -P INPUT ACCEPT
    ipt -t filter -P OUTPUT ACCEPT
    ipt -t filter -P FORWARD ACCEPT
}

chain_general_inboud() {
    ipt -t filter -N general_inbound
    allow_conntrack_in general_inbound
    drop_fragments_from general_inbound
}

chain_icmp_handling() {
    ipt -t filter -N icmp_handling

    allow4 icmp_handling "-p icmp --icmp-type 0"
    allow4 icmp_handling "-p icmp --icmp-type 3"
    allow4 icmp_handling "-p icmp --icmp-type 8"
    allow4 icmp_handling "-p icmp --icmp-type 11"
    drop4 icmp_handling

    allow6 icmp_handling "-p ipv6-icmp --icmpv6-type 1"
    allow6 icmp_handling "-p ipv6-icmp --icmpv6-type 2"
    allow6 icmp_handling "-p ipv6-icmp --icmpv6-type 3"
    allow6 icmp_handling "-p ipv6-icmp --icmpv6-type 4"
    allow6 icmp_handling "-p ipv6-icmp --icmpv6-type 128"
    allow6 icmp_handling "-p ipv6-icmp --icmpv6-type 133"
    allow6 icmp_handling "-p ipv6-icmp --icmpv6-type 134"
    allow6 icmp_handling "-p ipv6-icmp --icmpv6-type 135"
    allow6 icmp_handling "-p ipv6-icmp --icmpv6-type 136"
    allow6 icmp_handling "-p ipv6-icmp --icmpv6-type 137"
    allow6 icmp_handling "-p ipv6-icmp --icmpv6-type 141"
    allow6 icmp_handling "-p ipv6-icmp --icmpv6-type 142"
    allow6 icmp_handling "-s fe80::/10 -p ipv6-icmp --icmpv6-type 130"
    allow6 icmp_handling "-s fe80::/10 -p ipv6-icmp --icmpv6-type 131"
    allow6 icmp_handling "-s fe80::/10 -p ipv6-icmp --icmpv6-type 132"
    allow6 icmp_handling "-s fe80::/10 -p ipv6-icmp --icmpv6-type 143"
    allow6 icmp_handling "-p ipv6-icmp --icmpv6-type 148"
    allow6 icmp_handling "-p ipv6-icmp --icmpv6-type 149"
    allow6 icmp_handling "-s fe80::/10 -p ipv6-icmp --icmpv6-type 151"
    allow6 icmp_handling "-s fe80::/10 -p ipv6-icmp --icmpv6-type 152"
    allow6 icmp_handling "-s fe80::/10 -p ipv6-icmp --icmpv6-type 153"
    drop6 icmp_handling
}

chain_dhcp_handling() {
    ipt -t filter -N dhcp_handling
    allow4 dhcp_handling "-p udp -m udp --dport 68"
    allow6 dhcp_handling "-s fe80::/10 -d fe80::/10 -p udp -m udp --sport 547 --dport 546"
}

drop_fragments_from() {
    drop4 "$1" "-f"
}

allow_conntrack_in() {
    allow "$1" "-m conntrack --ctstate RELATED,ESTABLISHED"
    drop "$1" "-m conntrack --ctstate INVALID"
}

jump() {
    ipt -t filter -A ${1:+"$1"} ${2:+"$2"} ${3:+"$3"} -j ${4:+"$4"}
}

allow() {
    ipt -t filter -A ${1:+"$1"} ${2:+"$2"} ${3:+"$3"} -j ACCEPT
}

reject() {
    ipt -t filter -A ${1:+"$1"} ${2:+"$2"} ${3:+"$3"} -j REJECT
}

drop() {
    ipt -t filter -A ${1:+"$1"} ${2:+"$2"} ${3:+"$3"} -j DROP
}

jump4() {
    ipt4 -t filter -A ${1:+"$1"} ${2:+"$2"} ${3:+"$3"} -j ${4:+"$4"}
}

allow4() {
    ipt4 -t filter -A ${1:+"$1"} ${2:+"$2"} ${3:+"$3"} -j ACCEPT
}

reject4() {
    ipt4 -t filter -A ${1:+"$1"} ${2:+"$2"} ${3:+"$3"} -j REJECT
}

drop4() {
    ipt4 -t filter -A ${1:+"$1"} ${2:+"$2"} ${3:+"$3"} -j DROP
}

jump6() {
    ipt6 -t filter -A ${1:+"$1"} ${2:+"$2"} ${3:+"$3"} -j ${4:+"$4"}
}

allow6() {
    ipt6 -t filter -A ${1:+"$1"} ${2:+"$2"} ${3:+"$3"} -j ACCEPT
}

reject6() {
    ipt6 -t filter -A ${1:+"$1"} ${2:+"$2"} ${3:+"$3"} -j REJECT
}

drop6() {
    ipt6 -t filter -A ${1:+"$1"} ${2:+"$2"} ${3:+"$3"} -j DROP
}

dscp() {
    ipt -t mangle -A ${1:+"$1"} ${2:+"$2"} ${3:+"$3"} -m dscp --dscp 0x00 \
      -j DSCP --set-dscp ${4:+"$4"}
}

dscp4() {
    ipt4 -t mangle -A ${1:+"$1"} ${2:+"$2"} ${3:+"$3"} -m dscp --dscp 0x00 \
      -j DSCP --set-dscp ${4:+"$4"}
}

dscp6() {
    ipt6 -t mangle -A ${1:+"$1"} ${2:+"$2"} ${3:+"$3"} -m dscp --dscp 0x00 \
      -j DSCP --set-dscp ${4:+"$4"}
}

skip_mark() {
    ipt -t mangle -A ${1:+"$1"} ${2:+"$2"} -j RETURN
}

skip_mark4() {
    ipt4 -t mangle -A ${1:+"$1"} ${2:+"$2"} -j RETURN
}

skip_mark6() {
    ipt6 -t mangle -A ${1:+"$1"} ${2:+"$2"} -j RETURN
}

skip_dscp() {
    ipt -t mangle -A ${1:+"$1"} ${2:+"$2"} -j RETURN
}

skip_dscp4() {
    ipt4 -t mangle -A ${1:+"$1"} ${2:+"$2"} -j RETURN
}

skip_dscp6() {
    ipt6 -t mangle -A ${1:+"$1"} ${2:+"$2"} -j RETURN
}

mark() {
    ipt -t mangle -A ${1:+"$1"} ${2:+"$2"} -m mark --mark "$FOR_ANY" \
      -j MARK --set-mark ${3:+"$3"}
}

mark4() {
    ipt4 -t mangle -A ${1:+"$1"} ${2:+"$2"} -m mark --mark "$FOR_ANY" \
      -j MARK --set-mark ${3:+"$3"}
}

mark6() {
    ipt6 -t mangle -A ${1:+"$1"} ${2:+"$2"} -m mark --mark "$FOR_ANY" \
      -j MARK --set-mark ${3:+"$3"}
}

save_mark() {
    ipt -t mangle -A ${1:+"$1"} -j CONNMARK --save-mark --mask "$MARK_MASK"
}

save_mark4() {
    ipt4 -t mangle -A ${1:+"$1"} -j CONNMARK --save-mark --mask "$MARK_MASK"
}

save_mark6() {
    ipt6 -t mangle -A ${1:+"$1"} -j CONNMARK --save-mark --mask "$MARK_MASK"
}

restore_mark() {
    ipt -t mangle -A ${1:+"$1"} -j CONNMARK --restore-mark --mask "$MARK_MASK"
}

restore_mark4() {
    ipt4 -t mangle -A ${1:+"$1"} -j CONNMARK --restore-mark --mask "$MARK_MASK"
}

restore_mark6() {
    ipt6 -t mangle -A ${1:+"$1"} -j CONNMARK --restore-mark --mask "$MARK_MASK"
}

masquerade() {
    ipt -t nat -A POSTROUTING ${1:+"$1"} ${2:+"$2"} -j MASQUERADE
}

masquerade4() {
    ipt4 -t nat -A POSTROUTING ${1:+"$1"} ${2:+"$2"} -j MASQUERADE
}

masquerade6() {
    ipt6 -t nat -A POSTROUTING ${1:+"$1"} ${2:+"$2"} -j MASQUERADE
}

firewall() {
    policies

    # Input Rules
    jump INPUT "$FROM_ALL" "$ALL" general_inbound
    jump4 INPUT "$FROM_WAN" "-p icmp" icmp_handling
    jump4 INPUT "$FROM_VPN" "-p icmp" icmp_handling
    jump6 INPUT "$FROM_WAN" "-p icmpv6" icmp_handling
    jump INPUT "$FROM_WAN" "-p udp" dhcp_handling
    allow INPUT "$FROM_WAN" "-p tcp -m multiport --dports ssh,http,https"
    allow INPUT "$FROM_LO"
    allow INPUT "$FROM_LAN"
    drop INPUT

    # Forward Rules
    jump FORWARD "$FROM_ALL" "$ALL" general_inbound
    jump4 FORWARD "$FROM_WAN_TO_LAN" "-p icmp" icmp_handling
    jump6 FORWARD "$FROM_WAN_TO_LAN" "-p icmpv6" icmp_handling
    jump FORWARD "$FROM_WAN_TO_LAN" "-p udp" dhcp_handling
    allow FORWARD "$FROM_LAN_TO_WAN"
    drop FORWARD

    # Output Rules
    reject OUTPUT "$TO_BRIDGE" "-m owner --uid-owner debian-transmission"
}

dscp_tagging() {
    skip_dscp POSTROUTING "-m dscp ! --dscp 0x00"
    dscp4 POSTROUTING "$TO_VPN" "-p icmp" 0x01
    dscp4 POSTROUTING "$TO_VPN" "$ALL" 0x08
    dscp POSTROUTING "$TO_BRIDGE" "-p udp --dport domain" 0x04
    dscp POSTROUTING "$TO_BRIDGE" "-p tcp --dport ssh" 0x04
}

split_routing() {
    # Restore Marks
    restore_mark4 PREROUTING
    restore_mark4 OUTPUT

    # Mark Rules
    skip_mark4 OUTPUT "-m mark ! --mark $FOR_ANY"
    mark4 OUTPUT "$TO_LO" "$FOR_DEFAULT"
    mark4 OUTPUT "-m owner --uid-owner debian-transmission" "$FOR_DEFAULT"
    mark4 OUTPUT "$TO_ALL" "$FOR_BRIDGE"

    # Save Marks
    save_mark4 OUTPUT

    # Masquerade
    masquerade4 "$TO_BRIDGE" "-m mark --mark $FOR_BRIDGE"
}

policies
flush_firewall
chain_general_inboud
chain_dhcp_handling
chain_icmp_handling
firewall
dscp_tagging
split_routing